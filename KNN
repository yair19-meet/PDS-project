import pandas as pd
import numpy as np
from pathlib import Path
import matplotlib.pyplot as plt
from sklearn.impute import KNNImputer
from sklearn.preprocessing import StandardScaler

# ---- Reading file ----
csv_path = Path(__file__).parent / 'city_data.csv'
data = pd.read_csv(csv_path, delimiter='|')

# ---- Replacing the columns with first row ----
new_header = data.iloc[0]
data = data[1:]
data.columns = new_header

# ---- Split the City column into City + Country ----
cities = []
states = []
for i in range(len(data)):
    if ',' in data.iloc[i]["City"]:
        city_and_state = data.iloc[i]["City"].split(",")
    elif '.' in data.iloc[i]["City"]:
        city_and_state = data.iloc[i]["City"].split(".")
    else:
        city_and_state = data.iloc[i]["City"].split(";")
         
    cities.append(city_and_state[0])
    if len(city_and_state) > 1:
        states.append(city_and_state[1])
    else:
        states.append("")

data.drop(columns=['City'], inplace=True)
data.insert(0, 'City', cities)
data.insert(1, 'Country', states)

# ---- Remove column with too many missing values ----
data.drop(columns=['Average Price Groceries'], inplace=True)

# ---- Convert numeric columns from object -> float ----
for col in data.columns:
    try:
        data[col] = pd.to_numeric(data[col])
    except:
        pass  # keep text columns (City, Country) as is

# ---- Apply KNN Imputation on numeric columns ----
numeric_cols = data.select_dtypes(include=[np.number]).columns
scaler = StandardScaler()
scaled = scaler.fit_transform(data[numeric_cols])

imputer = KNNImputer(n_neighbors=7)
imputed_scaled = imputer.fit_transform(scaled)

# Inverse scale back
imputed = scaler.inverse_transform(imputed_scaled)

# Put back into DataFrame
data[numeric_cols] = imputed

#removing duplicate rows
data.drop_duplicates(inplace=True)

pd.set_option("display.max_rows", None)
pd.set_option("display.max_columns", None)

#changing type of columns from string to int
data['Population'] = data['Population'].astype(np.int64)
data['Average Monthly Salary'] = data['Average Monthly Salary'].astype(np.int64)
data['Average Cost of Living'] = data['Average Cost of Living'].astype(np.int64)

#displaying the total population of each country in the data set
population_ser = data.groupby('Country')['Population'].sum().sort_values(ascending=False)
population_summary = pd.DataFrame({"Population Total": population_ser})
print("\nPopulation Summary: \n")
print(population_summary)

#displaying data about quantity of cities
cities_count_ser = data.groupby('Country')['City'].count().sort_values(ascending=False)
amount_of_cities = pd.DataFrame({"Number of Cities": cities_count_ser})
total_number_of_cities = amount_of_cities['Number of Cities'].sum()
print("\nCities Summery:\n")
print(amount_of_cities)
print(f"\nAmount of Cities in total: {total_number_of_cities}\n")


#displaying data about cities with high salaries
print("\nHigh Salary Cities:\n")
print(data[data["Average Monthly Salary"] > 1600].sort_values(by='Average Monthly Salary', ascending=False)[["City", "Average Monthly Salary"]])

#displaying data about cities with low cost of living
print("\nLow Cost of living:\n")
print(data[data["Average Cost of Living"] < 900].sort_values(by="Average Cost of Living", ascending=False)[["City", "Average Cost of Living"]])

#calculating difference between average salary and average cost of living in cities
data["avg salary - avg cost of living"] = data["Average Monthly Salary"] - data["Average Cost of Living"]
print("\nDifference between cost of living and salary:\n")
print(data[['City', "avg salary - avg cost of living"]].sort_values(by='avg salary - avg cost of living', ascending=False).head(5))

#plot for showing correlation between Salary and Cost of Living
fig, ax = plt.subplots()
ax.scatter(data["Average Monthly Salary"], data["Average Cost of Living"])
ax.set_xlabel("Salary")
ax.set_ylabel("Cost of living")
plt.show()
